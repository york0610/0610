# Focus Finder 遊戲穩定性修復計劃

## 問題描述

用戶在手機上測試時發現嚴重的系統性問題：
1. **全螢幕閃退**: 錯過任務後系統退出全螢幕，閃退再回去全螢幕
2. **任務無法顯示**: 全螢幕閃退後任務卡片消失
3. **音樂爆炸**: 音效變成雜音
4. **遊戲無法結束**: 時間倒數變成負數，遊戲無法正常結束
5. **整個遊戲當機**: 所有功能停止響應

## 根本原因分析

這些問題都指向**全螢幕退出時的狀態管理混亂**：
- 全螢幕退出觸發多個 state 更新
- State 更新導致 useEffect 重新執行
- 計時器和音頻源沒有正確清理
- 任務狀態在混亂中丟失

---

## Stage 1: 全螢幕穩定性修復
**Goal**: 防止全螢幕退出導致的狀態混亂
**Success Criteria**: 
- 全螢幕退出時不會觸發遊戲重置
- 任務狀態保持穩定
- 計時器繼續正常運行
**Tests**: 
- 手動退出全螢幕，遊戲繼續運行
- 錯過任務時全螢幕重新進入，遊戲狀態不變
- 任務卡片始終可見
**Status**: Not Started

### 修復內容
1. 改進全螢幕事件處理 - 添加防抖機制
2. 使用 ref 追蹤全螢幕狀態，避免觸發 re-render
3. 只在扣分/干擾時重新進入，最多重試 3 次

---

## Stage 2: 計時器和音頻清理
**Goal**: 確保所有計時器和音頻源正確清理
**Success Criteria**: 
- 遊戲結束時所有計時器停止
- 音頻不會堆疊成雜音
- 時間倒數不會變成負數
**Tests**: 
- 遊戲時間到達 0 時正常結束
- 分數歸零時正常結束
- 結束後沒有音效繼續播放
**Status**: Not Started

### 修復內容
1. 添加 isGameEnding ref 防止重複觸發
2. 確保時間 <= 0 時立即結束
3. 遊戲結束時調用 audioManager.stopAll()

---

## Stage 3: 任務狀態管理
**Goal**: 確保任務狀態在任何情況下都保持一致
**Success Criteria**: 
- 任務卡片始終可見
- 任務超時後正確切換到下一個任務
- currentTask 永遠不為 null（遊戲運行時）
**Tests**: 
- 連續錯過 5 個任務，任務卡片始終顯示
- 全螢幕退出時任務不消失
- 任務超時計時器正確重置
**Status**: Not Started

### 修復內容
1. 確保 handleTaskTimeout 總是設置新的超時計時器
2. 添加任務狀態恢復機制
3. 修復 useMemo 依賴和邊界檢查

