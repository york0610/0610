{"version":3,"file":"resolver.js","sourceRoot":"","sources":["../../src/resolver.ts"],"names":[],"mappings":"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","sourcesContent":["import { middlewareHelper } from \"./middleware.js\"\nimport { mix } from \"./utils.js\"\nimport type { Wretch, WretchResponse, WretchResponseChain, WretchError as WretchErrorType } from \"./types.js\"\nimport { FETCH_ERROR, CATCHER_FALLBACK } from \"./constants.js\"\n\n/**\n * This class inheriting from Error is thrown when the fetch response is not \"ok\".\n * It extends Error and adds status, text and body fields.\n */\nexport class WretchError extends Error implements WretchErrorType {\n  status: number\n  response: WretchResponse\n  url: string\n  text?: string\n  json?: any\n}\n\nexport const resolver = <T, Chain, R>(wretch: T & Wretch<T, Chain, R>) => {\n  const sharedState = Object.create(null)\n\n  wretch = wretch._addons.reduce((w, addon) =>\n    addon.beforeRequest &&\n    addon.beforeRequest(w, wretch._options, sharedState)\n    || w,\n  wretch)\n\n  const {\n    _url: url,\n    _options: opts,\n    _config: config,\n    _catchers: _catchers,\n    _resolvers: resolvers,\n    _middlewares: middlewares,\n    _addons: addons\n  } = wretch\n\n  const catchers = new Map(_catchers)\n  const finalOptions = mix(config.options, opts)\n\n  // The generated fetch request\n  let finalUrl = url\n  const _fetchReq = middlewareHelper(middlewares)((url, options) => {\n    finalUrl = url\n    return config.polyfill(\"fetch\")(url, options)\n  })(url, finalOptions)\n  // Throws on an http error\n  const referenceError = new Error()\n  const throwingPromise: Promise<void | WretchResponse> = _fetchReq\n    .catch(error => {\n      throw { [FETCH_ERROR]: error }\n    })\n    .then(response => {\n      if (!response.ok) {\n        const err = new WretchError()\n        // Enhance the error object\n        err[\"cause\"] = referenceError\n        err.stack = err.stack + \"\\nCAUSE: \" + referenceError.stack\n        err.response = response\n        err.status = response.status\n        err.url = finalUrl\n\n        if (response.type === \"opaque\") {\n          throw err\n        }\n\n        const jsonErrorType = config.errorType === \"json\" || response.headers.get(\"Content-Type\")?.split(\";\")[0] === \"application/json\"\n        const bodyPromise =\n          !config.errorType ? Promise.resolve(response.body) :\n            jsonErrorType ? response.text() :\n              response[config.errorType]()\n\n        return bodyPromise.then((body: unknown) => {\n          err.message = typeof body === \"string\" ? body : response.statusText\n          if(body) {\n            if(jsonErrorType && typeof body === \"string\") {\n              err.text = body\n              try { err.json = JSON.parse(body) }\n              catch { /* ignore */ }\n            } else {\n              err[config.errorType] = body\n            }\n          }\n          throw err\n        })\n      }\n      return response\n    })\n  // Wraps the Promise in order to dispatch the error to a matching catcher\n  const catchersWrapper = <T>(promise: Promise<T>): Promise<void | T> => {\n    return promise.catch(err => {\n      const fetchErrorFlag = Object.prototype.hasOwnProperty.call(err, FETCH_ERROR)\n      const error = fetchErrorFlag ? err[FETCH_ERROR] : err\n\n      const catcher =\n        (error?.status && catchers.get(error.status)) ||\n        catchers.get(error?.name) || (\n          fetchErrorFlag && catchers.has(FETCH_ERROR) && catchers.get(FETCH_ERROR)\n        )\n\n      if (catcher)\n        return catcher(error, wretch)\n\n      const catcherFallback = catchers.get(CATCHER_FALLBACK)\n      if (catcherFallback)\n        return catcherFallback(error, wretch)\n\n      throw error\n    })\n  }\n  // Enforces the proper promise type when a body parsing method is called.\n  type BodyParser = <Type>(funName: \"json\" | \"blob\" | \"formData\" | \"arrayBuffer\" | \"text\" | null) => <Result = void>(cb?: (type: Type) => Result) => Promise<Awaited<Result>>\n  const bodyParser: BodyParser = funName => cb => funName ?\n    // If a callback is provided, then callback with the body result otherwise return the parsed body itself.\n    catchersWrapper(throwingPromise.then(_ => _ && _[funName]()).then(_ => cb ? cb(_) : _)) :\n    // No body parsing method - return the response\n    catchersWrapper(throwingPromise.then(_ => cb ? cb(_ as any) : _))\n\n  const responseChain: WretchResponseChain<T, Chain, R> = {\n    _wretchReq: wretch,\n    _fetchReq,\n    _sharedState: sharedState,\n    res: bodyParser<WretchResponse>(null),\n    json: bodyParser<any>(\"json\"),\n    blob: bodyParser<Blob>(\"blob\"),\n    formData: bodyParser<FormData>(\"formData\"),\n    arrayBuffer: bodyParser<ArrayBuffer>(\"arrayBuffer\"),\n    text: bodyParser<string>(\"text\"),\n    error(errorId, cb) {\n      catchers.set(errorId, cb)\n      return this\n    },\n    badRequest(cb) { return this.error(400, cb) },\n    unauthorized(cb) { return this.error(401, cb) },\n    forbidden(cb) { return this.error(403, cb) },\n    notFound(cb) { return this.error(404, cb) },\n    timeout(cb) { return this.error(408, cb) },\n    internalError(cb) { return this.error(500, cb) },\n    fetchError(cb) { return this.error(FETCH_ERROR, cb) },\n  }\n\n  const enhancedResponseChain: R extends undefined ? Chain & WretchResponseChain<T, Chain, undefined> : R = addons.reduce((chain, addon) => ({\n    ...chain,\n    ...(typeof addon.resolver === \"function\" ? (addon.resolver as (_: WretchResponseChain<T, Chain, R>) => any)(chain) : addon.resolver)\n  }), responseChain)\n\n  return resolvers.reduce((chain, r) => r(chain, wretch), enhancedResponseChain)\n}\n"]}